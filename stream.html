<html>

<head>

    <meta charset="UTF-8"/>
    <title>Live stream Overlay</title>

    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="moment.js"></script>
    <script src="settings.js"></script>
    <script src="events.js"></script>

</head>

<body>

<!-- Top match info -->
<div id="overlay-top">
	<div id="overlay-top-content" class="sbox-small flair" onclick="state.run_matches()">
		<div class="content">
			<p><span class="match-type">League:</span><span class="match-id">20/36</span></p>
		</div>
	</div>
</div>


<!-- Bottom ticker and zones -->
<div id="overlay-bottom">
	<div id="overlay-content">
	<div id="sourcebots-logo">
		<img src="SourceBots.png">
	</div>
	<div id="match-counter" class="sbox-med flair">
		<div class="content timer"><h2>
            <span class="clock">2:34</span>
            <span class="clock-info">Next Match: </span>
        </h2></div>
	</div>
	<div id="zones">
		<ul>
			<li class="sbox-small purple">
				<div class="content"><p>BBC: British Broadcasting corp</p></div>
			</li>
			<li class="sbox-small green">
				<div class="content"><p>NSA: National Security Agency</p></div>
			</li>
			<li class="sbox-small yellow">
				<div class="content"><p>BOB: Box of Boxes</p></div>
			</li>
			<li class="sbox-small orange">
				<div class="content"><p>RPF: Raspbery Pi Foundation</p></div>
			</li>
		</ul>
	</div>
	</div>	
</div>


<!-- Side bar scores -->
<div id="overlay-side">
	<div id="overlay-side-scores">
		<div class="sbox-med flair">
			<div class="content"><h2>League scores</h2></div>
		</div>
		<div class="table">
		<div class="row sbox-small">
			<div class="content"><p><span class="position">1</span><span>BBC</span><span class="score">4</span></p></div>
		</div>
		<div class="row sbox-small">
			<div class="content"><p><span class="position">2</span><span>NSA</span><span class="score">2</span></p></div>
		</div>
		<div class="row sbox-small">
			<div class="content"><p><span class="position">3</span><span>BBC</span><span class="score">4</span></p></div>
		</div>
		<div class="row sbox-small">
			<div class="content"><p><span class="position">4</span><span>BBC</span><span class="score">4</span></p></div>
		</div>
		<div class="row sbox-small">
			<div class="content"><p><span class="position">5</span><span>BBC</span><span class="score">4</span></p></div>
		</div>
		<div class="row sbox-small">
			<div class="content"><p><span class="position">6</span><span>BBC</span><span class="score">4</span></p></div>
		</div>
		<div class="row sbox-small">
			<div class="content"><p><span class="position">7</span><span>BBC</span><span class="score">4</span></p></div>
		</div>
		<div class="row sbox-small">
			<div class="content"><p><span class="position">8</span><span>BBC</span><span class="score">4</span></p></div>
		</div>

		</div>
	</div>
	<div id="overlay-side-upnext" class="hidden">
		<div class="sbox-med flair">
			<div class="content"><h2>Up Next</h2></div>
                </div>
		<div class="team-next sbox purple">
    			<div class="img"><img src="walle.png"></div>
        		<div class="name"><h2 style="">BBC</h2></div>
		</div>
		<div class="team-next sbox green">
    			<div class="img"><img src="t101.jpg"></div>
        		<div class="name"><h2 style="">NSA</h2></div>
		</div>
		<div class="team-next sbox yellow">
    			<div class="img"><img src="getty.jpg"></div>
        		<div class="name"><h2 style="">BOB</h2></div>
		</div>
                <div class="team-next sbox orange">
                        <div class="img"><img src="irobot.jpg"></div>
                        <div class="name"><h2 style="">RPF</h2></div>
                </div>


	</div>
</div>

<script>

/* overlay objects, used to control the overlay display*/
overlay={}

overlay.progressCounter={

    show: function()
    {
        $("#overlay-top-content").removeClass("hidden");
    },

    hide: function()
    {
        $("#overlay-top-content").addClass("hidden");
    },

    set_match: function(type,matchNumber,matchesTotal)
    {
        if(type=="league")
        {
            var prefix = "<span class=\"match-type\">League:</span>"
            var counter = `<span class="match-id">${matchNumber}/${matchesTotal}</span>`
            $("#overlay-top-content .content").html(`<p>${prefix}${counter}</p>`);
        }
        else
        {
            $("#overlay-top-content .content").html(`<p>${type} ${matchNumber}</p>`);
        }
    },
}

overlay.scores={

    show: function()
    {
        $("#overlay-side-scores").removeClass("hidden");
    },

    hide: function()
    {
        $("#overlay-side-scores").addClass("hidden");
    }
}

overlay.next={

    show: function()
    {
        $("#overlay-side-upnext").removeClass("hidden");
    },

    hide: function()
    {
        $("#overlay-side-upnext").addClass("hidden");
    }
}

overlay.zones = {

    show: function()
    {
        $("#zones").removeClass("hidden");
        $("#match-counter").removeClass("only");
    },

    hide: function()
    {
        $("#zones").addClass("hidden");
        $("#match-counter").addClass("only");
    }
}

overlay.matchCounter={

    set_mode: function(mode)
    {
        switch(mode) {
            case "pre":
                $("#match-counter").removeClass("clock-only");
                $("#match-counter .clock-info").html("Matches begin at:");
                this.fixedClock=true;
                break;
            case "gap":
                $("#match-counter").removeClass("clock-only");
                $("#match-counter .clock-info").html("Next Match:")
                this.fixedClock=false;
                break;
            case "match":
                $("#match-counter").addClass("clock-only");
                $("#match-counter .clock-info").html("")
                this.fixedClock=false;
                break;
            case "interval":
                $("#match-counter").removeClass("clock-only");
                $("#match-counter .clock-info").html("Matches resume at:")
                this.fixedClock=true;
                break;
    
        }
        $("#match-counter").width(($(".timer h2")[0].clientWidth)-10);
    },

    setNextMatch: function(match) {
        start= new Date(match.times.game.start)
        end= new Date(match.times.game.end)

        now = new Date();

        /* counter mode 
        Before comp use mode pre
        For long intervals use mode interval
        for standard match gaps use gap
        for in matches use match */


        if (start>now)
        {
            if(end>now)
            {
                console.log("recieved past match")
            }
            this.set_mode("match");
            this.target=parseInt(end.getTime());
        }

        diff = start-now;
        minutesToNext = diff/(60*1000);

        if (minutesToNext>10)
        {
            if(match.num==0)
            {
                this.set_mode("pre")
                this.target=parseInt(start.getTime());
            }
            else
            {
                /* when a long gap exists */
                this.set_mode("interval");
                this.target=parseInt(start.getTime());
            }
        }
        else
        {
            this.set_mode("gap");
            this.target=parseInt(start.getTime());
        }
    },
        
    startMatchCounter: function(time)
    {
        this.target=parseInt(Date.now()+(time*1000),10);
        console.log(this.target)
    },

    fixedClock: false,
    lastupdated: 0,
    target:0,

    /* clock tick function called every 1/10th of a second */
    runTick: function()
    {
        let timeNow = parseInt(Date.now()/1000,10);
        if (this.lastupdated >= timeNow)
        {
            return;
        }
        this.lastupdated = timeNow;
        //console.log("tick");

        if (this.fixedClock)
        {
            //console.log(Date.now()+(5*60*1000));
            //console.log(this.target)
            if (this.target<(Date.now()+(5*60*1000)))
            {
                console.log("switching to gap mode");
                this.set_mode("gap");
            }
        }

        if (this.fixedClock)
        {
            let startTime=new Date(this.target);
            hours = startTime.getHours();
            minutes = startTime.getMinutes();
            
            hours = hours < 10 ? "0" + hours : hours;
            minutes = minutes < 10 ? "0" + minutes : minutes;

            $("#match-counter .timer .clock").text(hours + ":" + minutes)
        }
        else
        {
            let timeDelta=(this.target-Date.now())
            if (timeDelta<0) timeDelta=0;
            minutes = parseInt((timeDelta/1000)/60,10);
            seconds = parseInt((timeDelta/1000)%60,10);

            seconds = seconds < 10 ? "0" + seconds : seconds;
            $("#match-counter .timer .clock").text(minutes + ":" + seconds);
        }
    }
}

</script>
<script>

state={}

state.set_pre_comp=function()
{
    overlay.scores.hide();
    overlay.matchCounter.set_mode("pre");
}

state.set_pre_match=function()
{
    overlay.scores.show();
    overlay.next.hide();
    overlay.matchCounter.set_mode("gap");
    overlay.zones.hide();
    overlay.progressCounter.show();
    overlay.progressCounter.set_match("league",3,36);
}

/* Runs the 30s pre match sequence */
state.run_pre_match=function()
{
    console.log("30s to match");
    state.match_start_minus_30();
    setTimeout(function() {
        console.log("10s to match")
        state.match_start_minus_10();
    },1000*(20)); //run 10s script
    setTimeout(function() {
        console.log("match start")
        state.match_start();
    },1000*(30)); //run start script
}

state.run_post_match=function()
{
    console.log("match end")
    state.match_end();
    setTimeout(function() {
        console.log("match end+10")
        state.match_end_plus_10();
    },1000*(10)); //run 10s script
}

state.run_matches=function()
{
    state.set_pre_match();
    overlay.matchCounter.startMatchCounter(120+59);
    setInterval(function() {
        setTimeout(state.run_pre_match,1000*30);
        setTimeout(state.run_post_match,1000*120);
    },(1000*2*60))
}

state.match_start_minus_30=function()
{
    overlay.scores.hide();
    overlay.next.show();
    overlay.progressCounter.set_match("league",4,36);
}

state.match_start_minus_10=function()
{
    overlay.next.hide();
    overlay.zones.show();
}

state.match_start=function()
{
    overlay.matchCounter.set_mode("match");
    overlay.matchCounter.startMatchCounter((1*60)-1);
}

state.match_end=function()
{
    overlay.matchCounter.set_mode("gap");
    overlay.matchCounter.startMatchCounter((1*60)-1);
    overlay.zones.hide();
}

state.match_end_plus_10=function()
{
    overlay.scores.show();
}

setInterval(overlay.matchCounter.runTick.bind(overlay.matchCounter),100)


</script>
<script>

onTeamUpdate = function(team)
{
	//console.log(team);
}

onMatchUpdate = function(match)
{
	console.log(match);
}


    
</script>

</body>
</html>
